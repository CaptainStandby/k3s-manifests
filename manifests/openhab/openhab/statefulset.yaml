apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openhab
spec:
  serviceName: openhab
  template:
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
        fsGroup: 9001
        runAsGroup: 9001
        runAsUser: 9001
      initContainers:
      - image: openhab/openhab
        name: init-directories
        command:
        - /bin/sh
        - -c
        - |-
          [ -z "$(ls -A "/openhab/userdata")" ] && cp -av "/openhab/dist/userdata/." "/openhab/userdata/";
          [ -z "$(ls -A "/openhab/conf")" ] && cp -av "/openhab/dist/conf/." "/openhab/conf/";
          touch /openhab/addons/.placeholder /openhab/conf/.placeholder;
          mkdir -p /openhab/userdata/cache /openhab/userdata/logs /openhab/userdata/persistence /openhab/userdata/tmp
        volumeMounts:
        - name: openhab-data
          mountPath: /openhab/userdata
        - name: openhab-addons
          mountPath: /openhab/addons
        - name: openhab-conf
          mountPath: /openhab/conf
      containers:
      - image: openhab/openhab
        name: openhab
        command:
        - /openhab/start.sh
        - server
        # env:
        # - name: CRYPTO_POLICY
        #   value: unlimited
        # - name: TZ
        #   value: Europe/Berlin
        # - name: USER_ID
        #   value: '9001'
        # - name: GROUP_ID
        #   value: '9001'
        securityContext:
          # seccompProfile:
          #   type: RuntimeDefault
          # runAsUser: 9001
          # runAsGroup: 9001
          runAsNonRoot: true
          privileged: false
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - all
        readinessProbe:
          timeoutSeconds: 3
          httpGet:
            path: /
            port: http
        livenessProbe:
          timeoutSeconds: 3
          initialDelaySeconds: 60
          httpGet:
            path: /
            port: http
        ports:
        - containerPort: 8080
          name: http
        volumeMounts:
        - name: openhab-data
          mountPath: /openhab/userdata
        - name: openhab-addons
          mountPath: /openhab/addons
        - name: openhab-conf
          mountPath: /openhab/conf
        - name: etc-localtime
          mountPath: /etc/localtime
      volumes:
      - name: openhab-data
        persistentVolumeClaim:
          claimName: openhab-pvc-data
        # emptyDir: {}
      - name: openhab-addons
        persistentVolumeClaim:
          claimName: openhab-pvc-addons
        # emptyDir: {}
      - name: openhab-conf
        persistentVolumeClaim:
          claimName: openhab-pvc-conf
        # emptyDir: {}
      - name: etc-localtime
        hostPath:
          path: /usr/share/zoneinfo/Europe/Berlin
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openhab-pvc-data
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-client
  resources:
    requests:
      storage: 128Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openhab-pvc-conf
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-client
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: openhab-pvc-addons
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-client
  resources:
    requests:
      storage: 1Gi
